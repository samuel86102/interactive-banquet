<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤æœƒäº’å‹•æŠ½ç - ä¸»ç•«é¢</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; overflow: hidden; }
        h1 { color: #fca311; }
        #tables-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px auto; max-width: 95vw; }
        .table-card { border: 2px solid #fca311; border-radius: 10px; width: 120px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #16213e; transition: all 0.3s ease; }
        .table-card.locked { background-color: #0f3460; border-color: #50c878; cursor: pointer; /* æ–°å¢ï¼šè®“é–å®šæ¡Œæ¬¡å¯ä»¥é»æ“Š */ }
        .table-card.locked:hover { background-color: #e94560; /* æ–°å¢ï¼šæ»‘é¼ ç§»éæ™‚è®Šè‰²æç¤º */ }
        .table-card.winner { transform: scale(1.2); box-shadow: 0 0 30px #ffd700; border-color: #ffd700; z-index: 10; }
        .table-id { font-size: 1.2em; font-weight: bold; color: #e94560; }
        .table-number { font-size: 2.5em; font-weight: bold; color: #ffffff; height: 50px; }
        #fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; pointer-events: none; }
        #winner-announcement { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #ffd700; padding: 40px; border-radius: 20px; font-size: 4em; z-index: 1000; animation: fadeIn 1s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* æ–°å¢ï¼šé‡ç½®æŒ‰éˆ•æ¨£å¼ */
        #reset-button { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; font-size: 1em; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1001; }
        #reset-button:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    <h1>é¤æœƒäº’å‹•æŠ½ç</h1>
    <div id="tables-container"></div>
    <div id="winner-announcement"></div>
    <div id="fireworks-container"></div>
    <button id="reset-button">é‡æ–°é–‹å§‹</button> <!-- æ–°å¢æŒ‰éˆ• -->

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.7/dist/index.umd.js"></script>
    <script>
        const socket = io();
        const tablesContainer = document.getElementById('tables-container');
        const winnerAnnounce = document.getElementById('winner-announcement');
        const fireworksContainer = document.getElementById('fireworks-container');
        const resetButton = document.getElementById('reset-button'); // æ–°å¢
        const fireworks = new Fireworks.default(fireworksContainer);

        let numberSpinners = {};
        let isGameOver = false; // æ–°å¢ï¼šéŠæˆ²çµæŸç‹€æ…‹æ——æ¨™

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderTables(state) {
            tablesContainer.innerHTML = '';
            const totalTables = state.total_tables;
            
            for (let i = 1; i <= totalTables; i++) {
                const table = state.tables[i];
                const card = document.createElement('div');
                card.classList.add('table-card');
                card.id = `table-${i}`;
                
                const tableIdDiv = document.createElement('div');
                tableIdDiv.classList.add('table-id');
                tableIdDiv.textContent = `ç¬¬ ${i} æ¡Œ`;
                
                const tableNumberDiv = document.createElement('div');
                tableNumberDiv.classList.add('table-number');
                tableNumberDiv.id = `number-${i}`;

                if (table.locked) {
                    card.classList.add('locked');
                    tableNumberDiv.textContent = table.number;
                    if (numberSpinners[i]) {
                        clearInterval(numberSpinners[i]);
                        delete numberSpinners[i];
                    }
                    // æ–°å¢ï¼šç‚ºå·²é–å®šçš„æ¡Œæ¬¡å¢åŠ é»æ“Šäº‹ä»¶ä»¥é‡ç½®
                    card.addEventListener('click', () => {
                        if (confirm(`æ‚¨ç¢ºå®šè¦é‡ç½®ã€Œç¬¬ ${i} æ¡Œã€å—ï¼Ÿ`)) {
                            socket.emit('reset_table', { table_id: i });
                        }
                    });
                } else {
                    if (!numberSpinners[i]) {
                        tableNumberDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                        numberSpinners[i] = setInterval(() => {
                            const numDiv = document.getElementById(`number-${i}`);
                            if (numDiv) {
                                numDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                            }
                        }, 100);
                    }
                }
                card.appendChild(tableIdDiv);
                card.appendChild(tableNumberDiv);
                tablesContainer.appendChild(card);
            }
        }

        function resetFrontend() {
            // åœæ­¢æ‰€æœ‰å‹•ç•«å’Œæ•ˆæœ
            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};
            fireworks.stop();
            
            // éš±è—å‹åˆ©è€…å®£å‘Š
            winnerAnnounce.style.display = 'none';
            winnerAnnounce.innerHTML = '';

            // ç§»é™¤æ‰€æœ‰ .winner class
            document.querySelectorAll('.winner').forEach(el => el.classList.remove('winner'));
            
            isGameOver = false;
        }

        socket.on('update_state', (state) => {
            console.log('State updated:', state);
            if (!isGameOver) { // éŠæˆ²çµæŸå¾Œï¼Œä¸å†å› ç‹€æ…‹æ›´æ–°è€Œé‡æ–°æ¸²æŸ“ï¼Œä»¥ä¿æŒå‹åˆ©ç•«é¢
                renderTables(state);
            }
        });

        socket.on('game_over', (data) => {
            console.log('Game Over!', data);
            isGameOver = true; // è¨­å®šéŠæˆ²çµæŸæ——æ¨™
            const winnerId = data.winner.table_id;
            const winnerNumber = data.winner.number;

            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};

            winnerAnnounce.innerHTML = `æ­å–œç¬¬ ${winnerId} æ¡Œ!<br>ğŸ‰ ${winnerNumber} ğŸ‰`;
            winnerAnnounce.style.display = 'block';

            const winnerCard = document.getElementById(`table-${winnerId}`);
            if (winnerCard) {
                winnerCard.classList.add('winner');
            }
            
            fireworks.start();
        });

        // æ–°å¢ï¼šé‡ç½®æŒ‰éˆ•çš„äº‹ä»¶ç›£è½
        resetButton.addEventListener('click', () => {
            if (confirm('æ‚¨ç¢ºå®šè¦é‡æ–°é–‹å§‹æ•´å€‹éŠæˆ²å—ï¼Ÿæ‰€æœ‰æ¡Œæ¬¡çš„è™Ÿç¢¼éƒ½å°‡è¢«æ¸…ç©ºã€‚')) {
                socket.emit('reset_game');
            }
        });

        // æ–°å¢ï¼šç›£è½å¾Œç«¯ç™¼å‡ºçš„é‡ç½®ä¿¡è™Ÿ
        socket.on('game_restarted', () => {
            console.log('Game has been restarted by admin.');
            resetFrontend();
            // æ”¶åˆ°é‡ç½®ä¿¡è™Ÿå¾Œï¼Œè«‹æ±‚ä¸€æ¬¡æœ€æ–°çš„ç‹€æ…‹ä¾†é‡æ–°æ¸²æŸ“
            socket.emit('connect'); // æ¨¡æ“¬é‡é€£ä¾†ç²å–åˆå§‹ç‹€æ…‹
        });
    </script>
</body>
</html>
