<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐會互動抽獎 - 主畫面</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; overflow: hidden; }
        h1 { color: #fca311; }
        #tables-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px auto; max-width: 95vw; }
        .table-card { border: 2px solid #fca311; border-radius: 10px; width: 120px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #16213e; transition: all 0.3s ease; }
        .table-card.locked { background-color: #0f3460; border-color: #50c878; cursor: pointer; /* 新增：讓鎖定桌次可以點擊 */ }
        .table-card.locked:hover { background-color: #e94560; /* 新增：滑鼠移過時變色提示 */ }
        .table-card.winner { transform: scale(1.2); box-shadow: 0 0 30px #ffd700; border-color: #ffd700; z-index: 10; }
        .table-id { font-size: 1.2em; font-weight: bold; color: #e94560; }
        .table-number { font-size: 2.5em; font-weight: bold; color: #ffffff; height: 50px; }
        #fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; pointer-events: none; }
        #winner-announcement { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #ffd700; padding: 40px; border-radius: 20px; font-size: 4em; z-index: 1000; animation: fadeIn 1s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* 新增：重置按鈕樣式 */
        #reset-button { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; font-size: 1em; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 1001; }
        #reset-button:hover { background-color: #c0392b; }
    </style>
</head>
<body>
    <h1>餐會互動抽獎</h1>
    <div id="tables-container"></div>
    <div id="winner-announcement"></div>
    <div id="fireworks-container"></div>
    <button id="reset-button">重新開始</button> <!-- 新增按鈕 -->

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.7/dist/index.umd.js"></script>
    <script>
        const socket = io();
        const tablesContainer = document.getElementById('tables-container');
        const winnerAnnounce = document.getElementById('winner-announcement');
        const fireworksContainer = document.getElementById('fireworks-container');
        const resetButton = document.getElementById('reset-button'); // 新增
        const fireworks = new Fireworks.default(fireworksContainer);

        let numberSpinners = {};
        let isGameOver = false; // 新增：遊戲結束狀態旗標

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderTables(state) {
            tablesContainer.innerHTML = '';
            const totalTables = state.total_tables;
            
            for (let i = 1; i <= totalTables; i++) {
                const table = state.tables[i];
                const card = document.createElement('div');
                card.classList.add('table-card');
                card.id = `table-${i}`;
                
                const tableIdDiv = document.createElement('div');
                tableIdDiv.classList.add('table-id');
                tableIdDiv.textContent = `第 ${i} 桌`;
                
                const tableNumberDiv = document.createElement('div');
                tableNumberDiv.classList.add('table-number');
                tableNumberDiv.id = `number-${i}`;

                if (table.locked) {
                    card.classList.add('locked');
                    tableNumberDiv.textContent = table.number;
                    if (numberSpinners[i]) {
                        clearInterval(numberSpinners[i]);
                        delete numberSpinners[i];
                    }
                    // 新增：為已鎖定的桌次增加點擊事件以重置
                    card.addEventListener('click', () => {
                        if (confirm(`您確定要重置「第 ${i} 桌」嗎？`)) {
                            socket.emit('reset_table', { table_id: i });
                        }
                    });
                } else {
                    if (!numberSpinners[i]) {
                        tableNumberDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                        numberSpinners[i] = setInterval(() => {
                            const numDiv = document.getElementById(`number-${i}`);
                            if (numDiv) {
                                numDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                            }
                        }, 100);
                    }
                }
                card.appendChild(tableIdDiv);
                card.appendChild(tableNumberDiv);
                tablesContainer.appendChild(card);
            }
        }

        function resetFrontend() {
            // 停止所有動畫和效果
            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};
            fireworks.stop();
            
            // 隱藏勝利者宣告
            winnerAnnounce.style.display = 'none';
            winnerAnnounce.innerHTML = '';

            // 移除所有 .winner class
            document.querySelectorAll('.winner').forEach(el => el.classList.remove('winner'));
            
            isGameOver = false;
        }

        socket.on('update_state', (state) => {
            console.log('State updated:', state);
            if (!isGameOver) { // 遊戲結束後，不再因狀態更新而重新渲染，以保持勝利畫面
                renderTables(state);
            }
        });

        socket.on('game_over', (data) => {
            console.log('Game Over!', data);
            isGameOver = true; // 設定遊戲結束旗標
            const winnerId = data.winner.table_id;
            const winnerNumber = data.winner.number;

            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};

            winnerAnnounce.innerHTML = `恭喜第 ${winnerId} 桌!<br>🎉 ${winnerNumber} 🎉`;
            winnerAnnounce.style.display = 'block';

            const winnerCard = document.getElementById(`table-${winnerId}`);
            if (winnerCard) {
                winnerCard.classList.add('winner');
            }
            
            fireworks.start();
        });

        // 新增：重置按鈕的事件監聽
        resetButton.addEventListener('click', () => {
            if (confirm('您確定要重新開始整個遊戲嗎？所有桌次的號碼都將被清空。')) {
                socket.emit('reset_game');
            }
        });

        // 新增：監聽後端發出的重置信號
        socket.on('game_restarted', () => {
            console.log('Game has been restarted by admin.');
            resetFrontend();
            // 收到重置信號後，請求一次最新的狀態來重新渲染
            socket.emit('connect'); // 模擬重連來獲取初始狀態
        });
    </script>
</body>
</html>
