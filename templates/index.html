<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>餐會互動抽獎 - 主畫面</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1a1a2e; color: #e0e0e0; text-align: center; margin: 0; padding: 20px; overflow: hidden; }
        h1 { color: #fca311; }
        #tables-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px auto; max-width: 95vw; }
        .table-card { border: 2px solid #fca311; border-radius: 10px; width: 120px; height: 120px; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #16213e; transition: all 0.3s ease; }
        .table-card.locked { background-color: #0f3460; border-color: #50c878; }
        .table-card.winner { transform: scale(1.2); box-shadow: 0 0 30px #ffd700; border-color: #ffd700; z-index: 10; }
        .table-id { font-size: 1.2em; font-weight: bold; color: #e94560; }
        .table-number { font-size: 2.5em; font-weight: bold; color: #ffffff; height: 50px; }
        #fireworks-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; pointer-events: none; }
        #winner-announcement { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: #ffd700; padding: 40px; border-radius: 20px; font-size: 4em; z-index: 1000; animation: fadeIn 1s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <h1>餐會互動抽獎</h1>
    <div id="tables-container"></div>
    <div id="winner-announcement"></div>
    <div id="fireworks-container"></div>

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.7/dist/index.umd.js"></script>
    <script>
        const socket = io();
        const tablesContainer = document.getElementById('tables-container');
        const winnerAnnounce = document.getElementById('winner-announcement');
        const fireworksContainer = document.getElementById('fireworks-container');
        const fireworks = new Fireworks.default(fireworksContainer);

        let numberSpinners = {};

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderTables(state) {
            tablesContainer.innerHTML = '';
            const totalTables = state.total_tables;
            
            for (let i = 1; i <= totalTables; i++) {
                const table = state.tables[i];
                const card = document.createElement('div');
                card.classList.add('table-card');
                card.id = `table-${i}`;
                
                const tableIdDiv = document.createElement('div');
                tableIdDiv.classList.add('table-id');
                tableIdDiv.textContent = `第 ${i} 桌`;
                
                const tableNumberDiv = document.createElement('div');
                tableNumberDiv.classList.add('table-number');
                tableNumberDiv.id = `number-${i}`;

                if (table.locked) {
                    card.classList.add('locked');
                    tableNumberDiv.textContent = table.number;
                    // 如果這個spinner正在跑，就停掉它
                    if (numberSpinners[i]) {
                        clearInterval(numberSpinners[i]);
                        delete numberSpinners[i];
                    }
                } else {
                    // 如果spinner還沒啟動，就啟動它
                    if (!numberSpinners[i]) {
                        tableNumberDiv.textContent = getRandomInt(1, 100);
                        numberSpinners[i] = setInterval(() => {
                            const numDiv = document.getElementById(`number-${i}`);
                            if (numDiv) {
                                numDiv.textContent = getRandomInt(1, 100);
                            }
                        }, 100);
                    }
                }
                card.appendChild(tableIdDiv);
                card.appendChild(tableNumberDiv);
                tablesContainer.appendChild(card);
            }
        }

        socket.on('update_state', (state) => {
            console.log('State updated:', state);
            renderTables(state);
        });

        socket.on('game_over', (data) => {
            console.log('Game Over!', data);
            const winnerId = data.winner.table_id;
            const winnerNumber = data.winner.number;

            // 停止所有動畫
            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};

            // 顯示勝利者
            winnerAnnounce.innerHTML = `恭喜第 ${winnerId} 桌!<br>🎉 ${winnerNumber} 🎉`;
            winnerAnnounce.style.display = 'block';

            // 標示出獲勝桌次
            const winnerCard = document.getElementById(`table-${winnerId}`);
            if (winnerCard) {
                winnerCard.classList.add('winner');
            }
            
            // 放煙火
            fireworks.start();
        });
    </script>
</body>
</html>
