<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>È§êÊúÉ‰∫íÂãïÊäΩÁçé - ‰∏ªÁï´Èù¢</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0D1B2A;
            --primary-card-bg: #1B263B;
            --secondary-card-bg: #415A77;
            --text-color: #E0E1DD;
            --accent-color: #FFC300;
            --locked-color: #50c878;
            --reset-color: #e74c3c;
            --reset-hover: #c0392b;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow: hidden;
        }
        h1 {
            color: var(--accent-color);
            font-weight: 700;
            font-size: 3em;
            text-shadow: 0 0 10px rgba(255, 195, 0, 0.5);
        }
        #tables-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px; /* Increased gap */
            margin: 40px auto;
            max-width: 95vw;
        }
        .table-card {
            border: 3px solid var(--secondary-card-bg);
            border-radius: 50%; /* Make it circular */
            width: 140px; /* Increased size */
            height: 140px; /* Increased size */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--primary-card-bg);
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        .table-card.locked {
            background-color: var(--primary-card-bg);
            border-color: var(--locked-color);
            cursor: pointer;
        }
        .table-card.locked:hover {
            transform: scale(1.05);
            border-color: var(--reset-color);
        }
        .table-card.winner {
            z-index: 10;
            animation: winner-glow 1.5s infinite alternate;
        }
        @keyframes winner-glow {
            from {
                transform: scale(1.1);
                box-shadow: 0 0 15px var(--accent-color);
                border-color: var(--accent-color);
            }
            to {
                transform: scale(1.15);
                box-shadow: 0 0 40px var(--accent-color);
                border-color: var(--accent-color);
            }
        }
        .table-id {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
        }
        .table-number {
            font-size: 3em;
            font-weight: 700;
            color: #ffffff;
            height: 60px;
        }
        #fireworks-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }
        #winner-announcement {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(13, 27, 42, 0.9);
            color: var(--accent-color);
            padding: 40px 60px;
            border-radius: 20px;
            font-size: 4.5em;
            font-weight: 700;
            z-index: 1000;
            animation: fadeIn 1s;
            border: 3px solid var(--accent-color);
            box-shadow: 0 0 50px rgba(255, 195, 0, 0.5);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -60%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        #reset-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 25px;
            font-size: 1em;
            font-weight: 600;
            background-color: var(--reset-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.2s ease;
        }
        #reset-button:hover {
            background-color: var(--reset-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <h1>È§êÊúÉ‰∫íÂãïÊäΩÁçé</h1>
    <div id="tables-container"></div>
    <div id="winner-announcement"></div>
    <div id="fireworks-container"></div>
    <button id="reset-button">ÈáçÊñ∞ÈñãÂßã</button> <!-- Êñ∞Â¢ûÊåâÈàï -->

    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.7/dist/index.umd.js"></script>
    <script>
        const socket = io();
        const tablesContainer = document.getElementById('tables-container');
        const winnerAnnounce = document.getElementById('winner-announcement');
        const fireworksContainer = document.getElementById('fireworks-container');
        const resetButton = document.getElementById('reset-button'); // Êñ∞Â¢û
        const fireworks = new Fireworks.default(fireworksContainer);

        let numberSpinners = {};
        let isGameOver = false; // Êñ∞Â¢ûÔºöÈÅäÊà≤ÁµêÊùüÁãÄÊÖãÊóóÊ®ô

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function renderTables(state) {
            tablesContainer.innerHTML = '';
            const totalTables = state.total_tables;
            
            for (let i = 1; i <= totalTables; i++) {
                const table = state.tables[i];
                const card = document.createElement('div');
                card.classList.add('table-card');
                card.id = `table-${i}`;
                
                const tableIdDiv = document.createElement('div');
                tableIdDiv.classList.add('table-id');
                tableIdDiv.textContent = `Á¨¨ ${i} Ê°å`;
                
                const tableNumberDiv = document.createElement('div');
                tableNumberDiv.classList.add('table-number');
                tableNumberDiv.id = `number-${i}`;

                if (table.locked) {
                    card.classList.add('locked');
                    tableNumberDiv.textContent = table.number;
                    if (numberSpinners[i]) {
                        clearInterval(numberSpinners[i]);
                        delete numberSpinners[i];
                    }
                    // Êñ∞Â¢ûÔºöÁÇ∫Â∑≤ÈéñÂÆöÁöÑÊ°åÊ¨°Â¢ûÂä†ÈªûÊìä‰∫ã‰ª∂‰ª•ÈáçÁΩÆ
                    card.addEventListener('click', () => {
                        if (confirm(`ÊÇ®Á¢∫ÂÆöË¶ÅÈáçÁΩÆ„ÄåÁ¨¨ ${i} Ê°å„ÄçÂóéÔºü`)) {
                            socket.emit('reset_table', { table_id: i });
                        }
                    });
                } else {
                    if (!numberSpinners[i]) {
                        tableNumberDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                        numberSpinners[i] = setInterval(() => {
                            const numDiv = document.getElementById(`number-${i}`);
                            if (numDiv) {
                                numDiv.textContent = getRandomInt(state.number_range[0], state.number_range[1]);
                            }
                        }, 100);
                    }
                }
                card.appendChild(tableIdDiv);
                card.appendChild(tableNumberDiv);
                tablesContainer.appendChild(card);
            }
        }

        function resetFrontend() {
            // ÂÅúÊ≠¢ÊâÄÊúâÂãïÁï´ÂíåÊïàÊûú
            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};
            fireworks.stop();
            
            // Èö±ËóèÂãùÂà©ËÄÖÂÆ£Âëä
            winnerAnnounce.style.display = 'none';
            winnerAnnounce.innerHTML = '';

            // ÁßªÈô§ÊâÄÊúâ .winner class
            document.querySelectorAll('.winner').forEach(el => el.classList.remove('winner'));
            
            isGameOver = false;
        }

        socket.on('update_state', (state) => {
            console.log('State updated:', state);
            if (!isGameOver) { // ÈÅäÊà≤ÁµêÊùüÂæåÔºå‰∏çÂÜçÂõ†ÁãÄÊÖãÊõ¥Êñ∞ËÄåÈáçÊñ∞Ê∏≤ÊüìÔºå‰ª•‰øùÊåÅÂãùÂà©Áï´Èù¢
                renderTables(state);
            }
        });

        socket.on('game_over', (data) => {
            console.log('Game Over!', data);
            isGameOver = true; // Ë®≠ÂÆöÈÅäÊà≤ÁµêÊùüÊóóÊ®ô
            const winnerId = data.winner.table_id;
            const winnerNumber = data.winner.number;

            Object.values(numberSpinners).forEach(clearInterval);
            numberSpinners = {};

            winnerAnnounce.innerHTML = `ÊÅ≠ÂñúÁ¨¨ ${winnerId} Ê°å!<br>üéâ ${winnerNumber} üéâ`;
            winnerAnnounce.style.display = 'block';

            const winnerCard = document.getElementById(`table-${winnerId}`);
            if (winnerCard) {
                winnerCard.classList.add('winner');
            }
            
            fireworks.start();
        });

        // Êñ∞Â¢ûÔºöÈáçÁΩÆÊåâÈàïÁöÑ‰∫ã‰ª∂Áõ£ËÅΩ
        resetButton.addEventListener('click', () => {
            if (confirm('ÊÇ®Á¢∫ÂÆöË¶ÅÈáçÊñ∞ÈñãÂßãÊï¥ÂÄãÈÅäÊà≤ÂóéÔºüÊâÄÊúâÊ°åÊ¨°ÁöÑËôüÁ¢ºÈÉΩÂ∞áË¢´Ê∏ÖÁ©∫„ÄÇ')) {
                socket.emit('reset_game');
            }
        });

        // Êñ∞Â¢ûÔºöÁõ£ËÅΩÂæåÁ´ØÁôºÂá∫ÁöÑÈáçÁΩÆ‰ø°Ëôü
        socket.on('game_restarted', () => {
            console.log('Game has been restarted by admin.');
            resetFrontend();
            // Êî∂Âà∞ÈáçÁΩÆ‰ø°ËôüÂæåÔºåË´ãÊ±Ç‰∏ÄÊ¨°ÊúÄÊñ∞ÁöÑÁãÄÊÖã‰æÜÈáçÊñ∞Ê∏≤Êüì
            socket.emit('connect'); // Ê®°Êì¨ÈáçÈÄ£‰æÜÁç≤ÂèñÂàùÂßãÁãÄÊÖã
        });
    </script>
</body>
</html>
